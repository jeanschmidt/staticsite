# Table of Contents
1. [Introduction](#introduction)
2. [Communication Protocol](#communication-protocol)
3. [Client Side Token](#client-side-token)
4. [Asynchronous process verification](#message-flow-and-asynchronous-process-verification) 
5. [Business Rules](#business-rules)
6. [User Interaction](#user-interaction)
7. [API Consumer System requirements](#api-consumer-system-requirements)
8. [API SERVICES](#api-services)
    1. [Message Header specification](#message-header-specification)
    2. [single medical item registration message](#single-medical-item-registration-message)
    3. [batch medical item registration message](#batch-medical-item-registration-message)
    4. [aggregation message](#aggregation-message)
    5. [register and aggregate message](#register-and-aggregate-message)
    6. [transference message](#transference-message)
    7. [end of life message](#end-of-life-message)
    8. [cancel event](#cancel-event)
    9. [events sync response structure](#events-sync-response-structure)
    10. [status service](#status-service)


## Introduction
This is the documentation site for R&B medical products track & trace proprietary API.
Version 2.0 of the API is a revamped version and have plenty of new functionality under the hood.
* Events are sent to the proper event capture service (registration,state change, aggregation or cancellation)
* Once processed the message will return:
    * http response code 200 for messages that were processed _without_ errors
    * http response code 400 for messages that were processed _with_ errors

## Communication Protocol
RB's API works under http (https://www.w3.org/Protocols/rfc2616/rfc2616-sec6.html) over SSL, meaning that all messages are encrypted with the server public key and can only be read by the server using it's private key. The key authenticity is guaranteed by the certification authority present in the certificate hierarchy.

We abide by the RFC2616 rules and recommendations, worth to quote is HTTP response code:
* 1xx: Informational - Request received, continuing process
* 2xx: Success - The action was successfully received, understood, and accepted
* 3xx: Redirection - Further action must be taken in order to complete the request
* 4xx: Client Error - The request contains bad syntax or cannot be fulfilled or contains business errors
* 5xx: Server Error - The server failed to fulfil an apparently valid request

**IMPLEMENTATION IMPORTANT INFORMATION**

#### 2xx responses
If the messages went through properly you are going to get a 200 code.

#### 4xx responses
*SHOULD NOT BE RETRIED WITHOUT THE PROPER CORRECTIONS*

If you receive a 4xx status code from a request it means one of the following:
* bad JSON format
* authentication Issue - Your authentication information is not valid
* authorization Issue - Although you have successfully authenticated, you are trying to perform an action which you do not have the proper permission
* business rule Issue - (see [business rule](#business-rules))

#### 5xx responses
* 504 Gateway Timeout - *ATTENTION* please see [asynchronous process verification](#asynchronous-process-verification) before retrying
* other 5xx errors - *SHOULD ALWAYS BE RETRIED* We suggest that the message should be retried after a predefined delay (maybe 30 seconds) but that is really up to your implementation requirements - usually means a server availability issue, so you should keep trying to send the messages until they through.

#### Broken connection
* *ATTENTION* please see[asynchronous process verification](#message-flow-and-asynchronous-process-verification) before retrying

## Client Side Token
Client side token is a unique token generated by the API Consumer system that can be used later process verification in case of a communication problem
The Client side token is **MANDATORY** for ALL track and trace messages and should be an implementation of the [UUID](https://en.wikipedia.org/wiki/Universally_unique_identifier) version 4 or version 5 (accordingly to [RFC4122](https://tools.ietf.org/html/rfc4122))
There are ready to go implementations of UUID for all known programming languages.

## Message Flow and Asynchronous process verification
In the advent of a timeout or a connection failure you need to verify if your message was properly processed or not before sending another message to the system.
Usually chances are that your message were received by our system before the timeout or the connection to break. So the first step would be to check (see [status check service](#status-service)) using your client-side-token if the message was received and if it was processed without errors before sending any other message (under the risk of breaking the sacred rule of messaging ordering)

**IMPLEMENTATION IMPORTANT INFORMATION:**
Message ordering is *paramount* so messages with common items (i.e. messages have at least one common item  directly or indirectly affected) should only be send after confirming that the previous message was processed without errors
*Here is how a failure should be handled*: An aggregation message and a quality retention message referring to the same aggregation should be send using the following flow:

1. generate Client Side Token (UUID_1)
2. send aggregation message with UUID_1
3. while waiting for the aggregation message response the connection was dropped
4. call the [status service](#status-service) using the UUID_1 token
5. assuming that the status service response was that the aggregation message was processed without errors
6. generate another Client Side Token (UUID_2) - have to be generated for every single message and cannot be reused
7. send a quality retention message referring to the previously created (and confirmed) aggregation
8. the system responds with a 200 code - processed without errors 


## Business Rules
All send events are asynchronously processed accordingly to these business rules:
* Existence (not applied for registration calls) - The item should be previously registered at RB
* Ownership - The item should be in possession of the event caller, which means that the product should not have a checkout from the user company registered before. (Regarding registration messages the validation is slightly different: the item will be checked for duplication and that if the company has production rights for this GTIN number)
* Chronology - The system is not going to accept messages that have timestamp that are less than the previously last accepted message timestamp, in other words, no event can have a date that is less that the last received and processed event
* Availability - The system is not going to accept messages that have items that are not available (i.e. have been disposed - theft, destruction, quality retention or any other end of life event status)

## User Interaction
**IMPLEMENTATION IMPORTANT INFORMATION:** Any business rule error should be *IMMEDIATELY* notified to the current system user. Business rules infringement are a regulation fault and you want to notified the system user (usually through the system GUI), for instance, if there is an ownership error for an specific aggregation you should tell the user to select another aggregation identifier because this aggregation was previously used and that will be a severe regulation fault to allow the user to continue using the faulty identifier. (aggregations identifiers do expire in a configurable time frame, if the aggregation identifier is expired it's not going to trigger ownership errors).

## API Consumer System requirements
Minimum requirements for any client system to be approved by RB quality standards:
* Have an audit trail of messages sent
* Have reports of currently enqueued messages
* Assure that messages are going to be processed in a orderly manner and that no sequence of messages with common items are going to be send without confirming the successful status of each one before send the next one.
* Will IMMEDIATELY warn the user of a business rule violation
* Will have the proper queue controls to guarantee that in case of server or connectivity issues the messages are going to be properly queued and are going to be send accordingly the common item order rules mentioned above (if an item is present at more then a message the system needs to guarantee that messages are going be send in order and that they will be successfully processed before send the next one)
* Will IMMEDIATELY warn the user that there is a communication issue (server or connectivity) so the user can take the proper actions

##API SERVICES

### Message Header specification 
All api messages should have the following header fields
* Company-Id: the company identification number provided by RB
* Login: the username 
* Auth-Token: the authentication token provided by RB or through the login process
* ClientSideToken - UUID -  a UUID is represented by 32 lowercase hexadecimal digits, displayed in five groups separated by hyphens, in the form 8-4-4-4-12 for a total of 36 characters (32 alphanumeric characters and four hyphens).

### single medical item registration message
* url: */rest/2/event/medical_item/registration*
* http method: *POST*


####message body:
* trackableItem
  * gtin - _mandatory_ - up to 14 digits
  * anvisaNumber - _mandatory_ - 13 numeric elements
  * serialNumber - _mandatory_ - 13 numeric elements
  * batchCode - _mandatory_ - up to 32 alpha numeric elements
  * expirationDate - _mandatory_ -  DDMMYY format
* info - _optional_ - up to 256 alpha numeric - should be used as an _"open"_ field, intended for security related information
* timestamp - _mandatory_ - Unix Timestamp in seconds
* timezoneOffset - _mandatory_ - signed integer

####message body example
```json
{
"trackableItem":{
    "gtin":"12345678901234",
    "anvisaNumber":"1234567890123",
    "serialNumber":"1234567890123",
    "batchCode":"AAAAAA",
    "expirationDate":"1014"
},
"info":"this is an example",
"timestamp":1404828334,
"timezoneOffset":-3
}
```


### batch medical item registration message
* url: */rest/2/event/medical_item/registration/batch*
* http method: *POST*


#### message body
* gtin - _mandatory_ - up to 14 digits
* anvisaNumber - _mandatory_ - 13 numeric elements
* serialNumbers - _mandatory_ - **ARRAY** of 13 numeric elements (up to 500)
* batchNumber - _mandatory_ - up to 32 alpha numeric elements
* expirationDate - _mandatory_ -  DDMMYY format
* info - _optional_ - up to 256 alpha numeric - should be used as an _"open"_ field, intended for security related information
* timestamp - _mandatory_ - Unix Timestamp
* timezoneOffset - _mandatory_ - signed integer

####message body example
```json
{
"gtin":"12345678901234",
"anvisaNumber":"1234567890123",
"batchCode":"AHF74634",
"expirationDate":"161014",
"serialNumbers":["0123987654321","0123987654322","0123987654323"],
"clientUserInfo":"line operator 1",
"timestamp":1404836728,
"timezoneOffset": -3,
"info":"this is an example",
}
```

### aggregation message
create or update an aggregation with previously registered items
* url: */rest/2/event/aggregate* 
* http method: *POST*

#### message body
* parentId - _mandatory_ - up to 64 alpha numeric - group identifier to be registered
* childrenIds - _mandatory_ -  ARRAY of trackableItemId (IUMs or other aggregations)
* volumeTypeCode - _mandatory_ - Integer (100=Pallet || 200= Bundle || 300= Case || 400= Package || 500= Virtual)
* info - _optional_ - up to 256 alpha numeric - should be used as an _"open"_ field, intended for security related information
* timestamp - _mandatory_ - Unix epoch time
* timezoneOffset - _mandatory_ - signed integer

####message body example
```json
{
"parentId":"543439074309988965",
"childrenIds":
    [
    "987654321012301239876543221014AHF74634",
    "987654321012301239876543231014AHF74634"
    ],
"volumeTypeCode":300,    
"info":"pallet operator",
"originId":1,
"timestamp":1415642847,
"timezoneOffset": -3
}
```

### transference message (checkout or checkin)
* url: */rest/2/event/change_state/batch*
* http method: *POST*

#### message body
* code - _mandatory_ - The event code - should be one of the listed below:
    * 3001 sale checkin (recebimento de compra)
    * 3002 transfer checkin (recebimento de transferencia)
    * 3003 donation checkin (recebimento em doação)
    * 3004 devolution checkin (recebimento em devolução)
    * 3005 recall checkin (recebimento em recolhimento) 
    * 3006 free sample checkin (recebimento de amostra gratis)
    * 4001 sale checkout (entrega de venda)
    * 4002 transfer checkout (entrega de transferencia) 
    * 4003 donation checkout (entrega de doação)
    * 4004 devolution checkout (entrega de devolução)
    * 4005 recall checkout (entrega de recolhimento)
    * 4006 free sample checkout (entrega de amostra gratis) 
    * 8000 importation
* trackableItemId - _mandatory_ - up to 64 alpha numeric **IMPORTANT** COULD BE EITHER AN IUM (unique medical identifier) OR AN AGGREGATION_ID/GROUP_ID (registered previously through the aggregation service)
* info - _optional_ - up to 1024 alpha numeric - To be used for events that need further detail (i.e. to which physician the giveaway/sample was given to or why the aggregation shipment was disabled)
* timestamp - _mandatory_  Unix epoch time IN SECONDS (NOT milliseconds)
* timezoneOffset - _mandatory_  signed integer
* toUniversalCompanyId - _mandatory_   up to 32 characters - An identifier representing the destination company
* toCpRegType - _mandatory_  integer - Fiscal information of Destination company identifier type:  (1=CNPJ || 2=CPF || 3=CNES || 4=RP || 5=CRM || 6=SGLN || 7=RN)
* toFiscalCpId - _mandatory_   up to 32 characters - An identifier representing the destination company
* toFiscalRegType _mandatory_  integer - Destination company identifier type:  (1=CNPJ || 2=CPF || 3=CNES || 4=RP || 5=CRM || 6=SGLN || 7=RN)
* byUniversalCompanyId - _mandatory_ (for all 3000s or 4000s codes) - An identifier representing the transportation company
* byCpRegType _mandatory_ (for all 3000s or 4000s codes)  integer - transportation company identifier type:  (1=CNPJ || 2=CPF || 3=CNES || 4=RP || 5=CRM || 6=SGLN || 7=RN)
* fromUniversalCompanyId - _mandatory_ (for all 3000s or 4000s codes) - An identifier representing the origin company 
* fromCpRegType _mandatory_ (for all 3000s or 4000s codes)  integer - origin company identifier type:  (1=CNPJ || 2=CPF || 3=CNES || 4=RP || 5=CRM || 6=SGLN || 7=RN)
* fromFiscalCpId- _mandatory_   up to 32 characters - An identifier representing the destination company
* fromFiscalRegType - _mandatory_  integer - Source company identifier type:  (1=CNPJ || 2=CPF || 3=CNES || 4=RP || 5=CRM || 6=SGLN || 7=RN)
* latitude - _optional_  float number - latitude of the event happened if not provided the user default latitude will be used
* longitude - _optional_  float number - longitude of the event happened if not provided the user default latitude will be used
* docs - _mandatory_ an array of document objects - must have at least one nota fiscal document!
    * document object:
        * type 
            * NF    NOTA FISCAL 
            * PO    ORDEM DE COMPRA
            * BOL    BILL OF LANDING
            * INV    INVOICE
            * RMA    RETURN MERCHANDISE AUTHORIZATION
            * PDG    PEDIGREE
            * DAV    DESPATCH ADVICE
            * RAV    RECEIVING ADVICE            
        * id - document identification number/code

#### message body example
```json
{
"code":4001,
"trackableItemId":"003443400434343",
"timestamp":1604828336,
"timezoneOffset":-3,
"docs": [{"type": "PO", "id": "36374343"}, {"type": "NF", "id": "89223.2323"}],
"latitude":-22.9033175,
"longitude":-43.177173599999996,
"toUniversalCompanyId":"00000000000000",
"toCpRegType":1,
"toFiscalCpId":"00000000000000",
"toFiscalRegType":1,
"fromUniversalCompanyId":"00000000000000",
"fromCpRegType":1,
"fromFiscalCpId":"00000000000000",
"fromFiscalRegType":1,
"byUniversalCompanyId":"89281688000139",
"byCpRegType":1
}
```
### end of life message (quality retention, destruction, etc.. )

* url: */rest/2/event/change_state/batch*
* http method: *POST*


#### message body
* code - _mandatory_ - The event code - should be one of the listed below:
    * 1012 Automatic Rejection
    * 1014 Manual Rejection
    * 1017 Quality
    * 1019 Retention
    * 5001 dispensation 
    * 5001 dispensation 
    * 5002 baixa(?)
    * 5003 misplacement
    * 5004 loss
    * 5005 discard
    * 5005 Insurance Occurrence
* trackableItemIds - _mandatory_ - ARRAY OF ITEMS up to 64 alpha numeric **IMPORTANT** COULD BE EITHER AN IUM (unique medical identifier) OR AN AGGREGATION_ID/GROUP_ID (registered previously through the aggregation service)
* info - _optional_ - up to 1024 alpha numeric - To be used for events that need further detail (i.e. to which physician the giveaway/sample was given to or why the aggregation shipment was disabled)
* timestamp - _mandatory_  Unix epoch time IN SECONDS (NOT milliseconds)
* timezoneOffset - _mandatory_  signed integer
* latitude - _optional_  float number - latitude of the event happened if not provided the user default latitude will be used
* longitude - _optional_  float number - longitude of the event happened if not provided the user default latitude will be used

#### message example
```json
{
"code":1017,
"trackableItemIds":["003443400434343","00737433494342"],
"timestamp":1604828336,
"timezoneOffset":-3,
"docs": [{"type": "PO", "id": "36374343"}, {"type": "NF", "id": "89223.2323"}],
"latitude":-22.9033175,
"longitude":-43.177173599999996,
}
```

### cancel event
* url: */rest/2/event/cancel*
* http method: *POST*

### message body

* eventId - _mandatory_ - event identification previously registered, except registration and cancellation, that is the token received upon message completion.
* clientUserInfo - _optional_ - up to 256 alpha numeric - should be used as an _"open"_ field, intended for security related information
* info - _optional_ - up to 1024 alpha numeric - To be used for events that need further detail (i.e. to which physician the giveaway/sample was given to or why the aggregation shipment was disabled)
* timestamp - _mandatory_  Unix epoch time IN SECONDS (NOT milliseconds)
* timezoneOffset - _mandatory_  signed integer

#### message example
```json
{
"eventId":"000O3J2IA0FA",
"clientUserInfo":"wrong checkout registered",
"info": "pallet detail 123",
"timestamp":1604828336,
"timezoneOffset":-3,
}
```

### events sync response structure

* token - _sempre vem_ - é o código que identifica a requisição, serve para chamar o status service, caso o campo _httpStatus_ não venha no corpo, indicando que a resposta será assíncrona. Quando há erro de autenticação/autorização ou no formato da mensagem enviada, esse campo não vem.
* httpStatus - _optional_ - a presença desse campo indica uma resposta síncrona. Se o valor for 200, o evento foi executado com sucesso, 400 erro de negócio detalhado nos campos _name_ e _number_, 300 checkin pendente do checkout correspondente, que será concluído assim que o checkout estiver OK.
(Os campos abaixo só aparecem em casos de _httpStatus_ 300 ou 400)
* number - código do erro.
* name - descrição do erro.
* items - Não é obrigatório vir esse campo. Existem eventos que afetam vários TrackableItems, quando acontece algum erro, nesse campo vem a lista de Ids de itens problemáticos em relação ao erro indicado nos campos _name_ e _number_
* errors - Também não vem sempre, só quando erro apresentado acima precisa ser decomposto. Esse campo é uma lista de objetos, onde cada objeto e composto pelos seguintes campos já apresentados acima: _httpStatus_, _number_, _name_ e _items_. Nas mesmas condições já descritas.

### success message
```json
{
  "token": "0000O5BQGJ0W",
  "httpCode": 200
}
```

### pending result
```json
{
  "token": "0000O5BQGJ0W"
}
```
### single error
```json
{
  "number": 2000,
  "name": "USER_NOT_LOGGED",
  "httpCode": 401
}
```

### single error with items
```json
{
  "number": 7000,
  "name": "DUPLICATED_IUM",
  "httpCode": 400,
  "items": [
    "100330154001214454349586051014H2Z8ZV66",
    "100330154001214454349586061014H2Z8ZV66",
    "100330154001214454349586071014H2Z8ZV66"
  ],
  "token": "000O5BQLN01C"
}
```

### decomposed erros
```json
{
  "number": 7022,
  "name": "BUSINESS_VALIDATION_ERROR",
  "httpCode": 400,
  "errors": [
    {
      "number": 7003,
      "name": "CHRONOLOGY_ERROR",
      "httpCode": 400,
      "items": [
        "100330154001214454349583071014H2Z8ZV66"
      ]
    },
    {
      "number": 7004,
      "name": "POSSESSION_ERROR",
      "httpCode": 400,
      "items": [
        "100330154001214454349583071014H2Z8ZV66"
      ]
    }
  ],
  "token": "000O5BQVS020"
}
```
### status service
* url: */rest/2/eventstatus/{clientSideToken}*
* http method: *GET*


#### Message response on success
```json
{
  "status": {
    "code":200
  }
}
```
#### Message response on error
```json
{
  "status": {
    "code": 400,
    "errors": [{
      "code": 7003,
      "message": "CHRONOLOGY_ERROR",
      "items": [
        "1000000000001144543395824901014H2Z8ZV66"
      ]
    }, {
      "code": 7004,
      "message": "POSSESSION_ERROR",
      "items": [
        "1000000000001144543395824901014H2Z8ZV66"
      ]
    }]
  }
}
```
 
